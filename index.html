<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe's Finance Command Center V9.0</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-green: #39ff14;
            --neon-red: #ff3131;
            --bg-dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.9);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            background-image: radial-gradient(circle at top right, rgba(0,210,255,0.15), transparent);
            color: white; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            width: 100%; max-width: 450px; padding: 25px; border-radius: 24px;
            border: 1px solid rgba(0, 210, 255, 0.4);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);
        }

        /* å„€è¡¨æ¿ */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-bottom: 25px; background: rgba(0,0,0,0.4); padding: 15px;
            border-radius: 18px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-box { text-align: center; }
        .stat-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: bold; margin-top: 5px; font-family: monospace; }
        .net-box { grid-column: span 2; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        
        .income-text { color: var(--neon-green); }
        .expense-text { color: var(--neon-red); }
        .net-text { color: var(--neon-blue); }

        /* æƒæå€ */
        .scan-zone {
            border: 2px dashed var(--neon-blue); border-radius: 16px; padding: 20px;
            text-align: center; margin-bottom: 20px; cursor: pointer;
        }
        #status-msg { font-size: 12px; color: var(--neon-green); margin-top: 10px; }
        #preview-img { width: 100%; max-height: 120px; object-fit: contain; display: none; margin-top: 15px; border-radius: 10px; }

        /* è¼¸å…¥æ¡† */
        .input-group { margin-bottom: 15px; }
        .label { font-size: 11px; color: var(--neon-blue); margin-bottom: 5px; display: block; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; color: white; font-size: 16px; box-sizing: border-box;
        }
        /* æ—¥æœŸæ¬„ä½ç‰¹åˆ¥è‰² */
        #date { border-color: var(--neon-green); color: var(--neon-green); }

        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        .save-btn {
            width: 100%; padding: 18px; background: linear-gradient(45deg, var(--neon-blue), #0081ff);
            border: none; border-radius: 14px; color: #000; font-size: 18px; font-weight: 900;
            cursor: pointer; text-transform: uppercase; margin-top: 10px;
        }
        .save-btn:disabled { background: #334155; color: #94a3b8; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align: center; color: var(--neon-blue); margin-top:0;">FINANCE MONITOR V9.0</h2>
    
    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-label">TOTAL INCOME</div>
            <div id="disp-income" class="stat-value income-text">$ 0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">TOTAL EXPENSE</div>
            <div id="disp-expense" class="stat-value expense-text">$ 0</div>
        </div>
        <div class="stat-box net-box">
            <div class="stat-label">NET BALANCE (æ·¨å€¼)</div>
            <div id="disp-net" class="stat-value net-text">$ 0</div>
        </div>
    </div>

    <div class="scan-zone" onclick="document.getElementById('file-input').click()">
        <div style="font-size: 30px;">ğŸ“¸</div>
        <div id="status-msg">READY TO SCAN</div>
        <img id="preview-img">
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none">

    <div class="input-group">
        <span class="label">ğŸ“… DATE / æ—¥æœŸ</span>
        <input type="date" id="date">
    </div>

    <div class="input-group">
        <span class="label">ITEM / é …ç›®</span>
        <input type="text" id="desc" placeholder="è¼¸å…¥æˆ–æƒæåç¨±">
    </div>
    
    <div class="input-group">
        <span class="label">AMOUNT / é‡‘é¡</span>
        <input type="number" id="amount" placeholder="0" inputmode="decimal">
    </div>

    <div class="input-group">
        <span class="label">TARGET / æ”¯å‡ºå°è±¡</span>
        <select id="member">
            <option value="æˆ‘">ğŸ§‘ æˆ‘</option>
            <option value="è€å©†">ğŸ‘© è€å©†</option>
            <option value="å†°æ£’">ğŸ• å†°æ£’</option>
            <option value="é›ªç³•">ğŸˆ é›ªç³•</option>
            <option value="å®¶åº­">ğŸ  å®¶åº­</option>
            <option value="å®¶æ—">ğŸŒ å®¶æ—</option>
        </select>
    </div>
    
    <div class="row">
        <div class="input-group">
            <span class="label">TYPE / é¡å‹</span>
            <select id="type">
                <optgroup label="æ”¯å‡ºé …ç›®">
                    <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                    <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                    <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                    <option value="é†«ç™‚">ğŸ¥ é†«ç™‚</option>
                    <option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                </optgroup>
                <optgroup label="æ”¶å…¥é …ç›®">
                    <option value="æœ¬è–ª">ğŸ’° æœ¬è–ª</option>
                    <option value="å‡ºå·®è£œåŠ©">âœˆï¸ å‡ºå·®è£œåŠ©</option>
                    <option value="è‚¡ç¥¨åƒ¹å·®">ğŸ“ˆ è‚¡ç¥¨åƒ¹å·®</option>
                    <option value="è‚¡åˆ©æ”¶ç›Š">ğŸ’¹ è‚¡åˆ©æ”¶ç›Š</option>
                    <option value="å…¶ä»–æ”¶å…¥">ğŸ§§ å…¶ä»–æ”¶å…¥</option>
                </optgroup>
            </select>
        </div>
        <div class="input-group">
            <span class="label">PAYMENT / æ–¹å¼</span>
            <select id="method">
                <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                <option value="åˆ·å¡">ğŸ’³ ä¿¡ç”¨å¡</option>
                <option value="LinePay">ğŸ“± LinePay</option>
                <option value="éŠ€è¡Œè½‰å¸³">ğŸ¦ éŠ€è¡Œè½‰å¸³</option>
            </select>
        </div>
    </div>

    <button onclick="saveData()" id="saveBtn" class="save-btn">EXECUTE SYNC</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwPu2wDdL1oX-izhvJSNjxEpFbskKunk8eCalpjlSl4V_obFjDxBqLH1HzWGUof__hd/exec";

    // 1. åˆå§‹åŒ–æ—¥æœŸèˆ‡çµ±è¨ˆ
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        refreshStats();
    };

    async function refreshStats() {
        try {
            const response = await fetch(GAS_URL);
            const data = await response.json();
            document.getElementById('disp-income').innerText = `$ ${data.income.toLocaleString()}`;
            document.getElementById('disp-expense').innerText = `$ ${data.expense.toLocaleString()}`;
            document.getElementById('disp-net').innerText = `$ ${data.net.toLocaleString()}`;
        } catch (e) { console.error("Sync Error"); }
    }

    // 2. æ”¶å…¥é …ç›®é€£å‹•å¡«å¯«
    document.getElementById('type').onchange = function() {
        const incomeTypes = ["æœ¬è–ª", "å‡ºå·®è£œåŠ©", "è‚¡ç¥¨åƒ¹å·®", "è‚¡åˆ©æ”¶ç›Š", "å…¶ä»–æ”¶å…¥"];
        if (incomeTypes.includes(this.value)) {
            document.getElementById('desc').value = this.value;
        }
    };

    // 3. æƒæè¾¨è­˜
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('preview-img').src = URL.createObjectURL(file);
        document.getElementById('preview-img').style.display = 'block';
        document.getElementById('status-msg').innerText = "ğŸ“¡ SCANNING...";

        try {
            const worker = await Tesseract.createWorker('chi_tra+eng');
            const { data: { text } } = await worker.recognize(file);
            const nums = text.match(/\d+/g);
            if (nums) {
                const prices = nums.map(Number).filter(n => n >= 10 && n < 10000);
                if (prices.length > 0) document.getElementById('amount').value = Math.max(...prices);
            }
            await worker.terminate();
            document.getElementById('status-msg').innerText = "âœ… SCAN DONE";
        } catch (err) { document.getElementById('status-msg').innerText = "âŒ ERROR"; }
    };

    // 4. å‚³é€è³‡æ–™ (å«æ—¥æœŸ)
    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value, // å‚³é€æ‰‹é¸æ—¥æœŸ
            desc: document.getElementById('desc').value,
            amount: document.getElementById('amount').value,
            type: document.getElementById('type').value,
            method: document.getElementById('method').value,
            member: document.getElementById('member').value,
            note: ""
        };

        if (!data.desc || !data.amount) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        btn.disabled = true;

        try {
            await fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify(data) });
            alert("âœ… åŒæ­¥æˆåŠŸï¼");
            location.reload(); 
        } catch (e) {
            alert("éŒ¯èª¤ï¼š" + e);
            btn.disabled = false;
        }
    }
</script>
</body>
</html>