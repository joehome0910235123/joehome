<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe's Finance Dashboard</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --neon-blue: #00d2ff;
            --neon-green: #39ff14;
            --neon-red: #ff3131;
            --bg-dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.9);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            background-image: radial-gradient(circle at top right, rgba(0,210,255,0.15), transparent);
            color: white; margin: 0; padding: 15px; display: flex; justify-content: center; min-height: 100vh;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            width: 100%; max-width: 450px; padding: 25px; border-radius: 24px;
            border: 1px solid rgba(0, 210, 255, 0.4);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);
        }

        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-bottom: 20px; background: rgba(0,0,0,0.4); padding: 15px;
            border-radius: 18px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-box { text-align: center; }
        .stat-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: bold; font-family: monospace; margin-top: 4px; }
        .net-box { grid-column: span 2; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); }
        
        .income-text { color: var(--neon-green); }
        .expense-text { color: var(--neon-red); }
        .net-text { color: var(--neon-blue); }

        /* åœ–è¡¨å€å¡Š */
        #piechart {
            width: 100%; height: 200px; margin-bottom: 20px;
            border-radius: 15px; background: rgba(255,255,255,0.02);
            display: flex; align-items: center; justify-content: center;
        }

        .input-group { margin-bottom: 12px; }
        .label { font-size: 11px; color: var(--neon-blue); margin-bottom: 4px; display: block; font-weight: bold; }
        input, select {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; color: white; font-size: 16px; box-sizing: border-box;
        }
        input:focus { border-color: var(--neon-green); outline: none; }
        #amount { font-size: 26px; color: var(--neon-green); text-align: center; font-weight: bold; }

        .save-btn {
            width: 100%; padding: 16px; background: linear-gradient(45deg, var(--neon-blue), #0081ff);
            border: none; border-radius: 14px; color: #000; font-size: 18px; font-weight: 900;
            cursor: pointer; margin-top: 10px; text-transform: uppercase;
        }
        .save-btn:disabled { background: #334155; color: #94a3b8; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align: center; color: var(--neon-blue); margin: 0 0 15px 0; letter-spacing: 2px;">JOE'S FINANCE</h2>
    
    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-label">Income</div>
            <div id="disp-income" class="stat-value income-text">$ 0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Expense</div>
            <div id="disp-expense" class="stat-value expense-text">$ 0</div>
        </div>
        <div class="stat-box net-box">
            <div class="stat-label">Net Balance</div>
            <div id="disp-net" class="stat-value net-text">$ 0</div>
        </div>
    </div>

    <div id="piechart">è¼‰å…¥ä¸­...</div>

    <div class="input-group">
        <span class="label">ğŸ“… Date</span>
        <input type="date" id="date">
    </div>

    <div class="input-group">
        <span class="label">Item</span>
        <input type="text" id="desc" placeholder="è¼¸å…¥é …ç›®åç¨±">
    </div>
    
    <div class="input-group">
        <span class="label">Amount</span>
        <input type="number" id="amount" placeholder="0" inputmode="decimal">
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
        <div>
            <span class="label">Target</span>
            <select id="member">
                <option value="æˆ‘">ğŸ§‘ æˆ‘</option>
                <option value="è€å©†">ğŸ‘© è€å©†</option>
                <option value="å†°æ£’">ğŸ• å†°æ£’</option>
                <option value="é›ªç³•">ğŸˆ é›ªç³•</option>
                <option value="å®¶åº­">ğŸ  å®¶åº­</option>
            </select>
        </div>
        <div>
            <span class="label">Type</span>
            <select id="type">
                <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option>
                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                <option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option>
                <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                <option value="é†«ç™‚">ğŸ¥ é†«ç™‚</option>
                <option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                <option value="æœ¬è–ª">ğŸ’° æœ¬è–ª</option>
                <option value="å…¶ä»–æ”¶å…¥">ğŸ§§ å…¶ä»–æ”¶å…¥</option>
            </select>
        </div>
    </div>

    <button onclick="saveData()" id="saveBtn" class="save-btn">Sync to Ledger</button>
</div>

<script>
    // âš ï¸ é€™è£¡è²¼ä¸Šä½ çš„ GAS ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwPu2wDdL1oX-izhvJSNjxEpFbskKunk8eCalpjlSl4V_obFjDxBqLH1HzWGUof__hd/exec"; 

    google.charts.load('current', {'packages':['corechart']});

    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        refreshStats();
    };

    async function refreshStats() {
        try {
            const response = await fetch(GAS_URL);
            const rows = await response.json(); 

            let income = 0;
            let expense = 0;
            let categoryMap = {};
            const incomeTypes = ["æœ¬è–ª", "å‡ºå·®è£œåŠ©", "è‚¡ç¥¨åƒ¹å·®", "è‚¡åˆ©æ”¶ç›Š", "å…¶ä»–æ”¶å…¥"];

            // å¾ç´¢å¼• 1 é–‹å§‹è¨ˆç®—
            for (let i = 1; i < rows.length; i++) {
                let amt = Number(rows[i][2]); 
                let cat = rows[i][3];         
                if (isNaN(amt) || amt === 0) continue;

                if (incomeTypes.includes(cat)) {
                    income += amt;
                } else {
                    expense += amt;
                    categoryMap[cat] = (categoryMap[cat] || 0) + amt;
                }
            }

            document.getElementById('disp-income').innerText = `$ ${income.toLocaleString()}`;
            document.getElementById('disp-expense').innerText = `$ ${expense.toLocaleString()}`;
            document.getElementById('disp-net').innerText = `$ ${(income - expense).toLocaleString()}`;

            let chartData = Object.entries(categoryMap);
            if (chartData.length > 0) {
                google.charts.setOnLoadCallback(() => drawChart(chartData));
            } else {
                document.getElementById('piechart').innerHTML = `<div style="color:#475569;font-size:12px;">ğŸ“Š å°šç„¡æ”¯å‡ºæ•¸æ“š</div>`;
            }
        } catch (e) {
            document.getElementById('piechart').innerHTML = `<div style="color:red;font-size:12px;">âš ï¸ é€£ç·šå¤±æ•—</div>`;
        }
    }

    function drawChart(chartData) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Category');
        data.addColumn('number', 'Amount');
        data.addRows(chartData);

        var options = {
            backgroundColor: 'transparent',
            legend: { textStyle: { color: '#94a3b8', fontSize: 11 }, position: 'right' },
            pieHole: 0.4,
            colors: ['#00d2ff', '#39ff14', '#ff3131', '#facc15', '#a855f7', '#fb923c'],
            chartArea: { width: '100%', height: '80%' },
            pieSliceBorderColor: "none"
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
    }

    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('date').value,
            desc: document.getElementById('desc').value,
            amount: document.getElementById('amount').value,
            type: document.getElementById('type').value,
            member: document.getElementById('member').value,
            method: "æ‰‹å‹•è¼¸å…¥"
        };

        if (!data.desc || !data.amount) return alert("è«‹å®Œæ•´å¡«å¯«é …ç›®èˆ‡é‡‘é¡");
        
        btn.disabled = true;
        btn.innerText = "Syncing...";

        try {
            await fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify(data) });
            alert("âœ… åŒæ­¥æˆåŠŸ");
            location.reload(); 
        } catch (e) {
            alert("åŒæ­¥å¤±æ•—");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>