<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe's Family Finance PRO</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --neon-blue: #00d2ff; --neon-green: #39ff14; --neon-red: #ff3131;
            --bg-dark: #0f172a; --glass: rgba(30, 41, 59, 0.9);
        }
        body {
            font-family: system-ui, -apple-system, sans-serif; background: var(--bg-dark);
            color: white; margin: 0; padding: 10px; display: flex; justify-content: center;
        }
        .card { background: var(--glass); width: 100%; max-width: 500px; padding: 15px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .title { text-align: center; color: var(--neon-blue); letter-spacing: 2px; margin: 0 0 15px 0; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 15px; text-align: center; }
        .stat-label { font-size: 10px; color: #94a3b8; margin-bottom: 4px; }
        .stat-value { font-size: 13px; font-weight: bold; font-family: monospace; }

        .charts-row { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 10px; }
        .chart-box { flex: 1; min-width: 0; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; }
        .chart-obj { width: 100%; height: 80px; }
        .custom-legend { width: 100%; font-size: 8px; margin-top: 5px; display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; }
        .legend-item { display: flex; align-items: center; gap: 2px; color: #cbd5e1; }
        .dot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; }

        .section-title { font-size: 12px; color: var(--neon-blue); font-weight: bold; margin: 15px 0 8px 0; border-left: 3px solid var(--neon-blue); padding-left: 8px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
        .label { font-size: 10px; color: #94a3b8; margin-bottom: 4px; display: block; }
        input, select { width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 14px; box-sizing: border-box; }
        
        .save-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #00d2ff, #0081ff); border: none; border-radius: 12px; color: #000; font-size: 16px; font-weight: 900; cursor: pointer; margin-top: 5px; }
        .query-btn { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--neon-blue); border-radius: 8px; color: var(--neon-blue); font-weight: bold; cursor: pointer; }
        
        .quick-btns { display: flex; gap: 4px; margin-bottom: 10px; }
        .quick-btns button { flex: 1; padding: 6px; font-size: 11px; background: rgba(255,255,255,0.05); border: none; color: #94a3b8; border-radius: 6px; cursor: pointer; }
        .quick-btns button.active { background: var(--neon-blue); color: #000; font-weight: bold; }
        #search-res { margin-top: 10px; padding: 10px; background: rgba(0,210,255,0.1); border-radius: 10px; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h3 class="title">ğŸ’ JOE ä¸€è·¯ç™¼</h3>

    <div class="quick-btns">
        <button onclick="setQuickDate('today', this)">ä»Šæ—¥</button>
        <button onclick="setQuickDate('month', this)" class="active">æœ¬æœˆ</button>
        <button onclick="setQuickDate('year', this)">æœ¬å¹´</button>
    </div>

    <div class="dashboard">
        <div><div class="stat-label">ğŸ’° æ”¶å…¥</div><div id="disp-income" class="stat-value" style="color:var(--neon-green)">$0</div></div>
        <div><div class="stat-label">ğŸ’¸ æ”¯å‡º</div><div id="disp-expense" class="stat-value" style="color:var(--neon-red)">$0</div></div>
        <div><div class="stat-label">ğŸ¦ çµé¤˜</div><div id="disp-net" class="stat-value" style="color:var(--neon-blue)">$0</div></div>
    </div>

    <div class="charts-row">
        <div class="chart-box">
            <div id="inc-chart" class="chart-obj"></div>
            <div id="inc-legend" class="custom-legend"></div>
        </div>
	<div class="chart-box">
            <div id="exp-chart" class="chart-obj"></div>
            <div id="exp-legend" class="custom-legend"></div>
        </div>
        <div class="chart-box">
            <div id="net-chart" class="chart-obj"></div>
            <div id="net-legend" class="custom-legend"></div>
        </div>        
    </div>

    <div class="section-title">âœï¸ æ–°å¢å¸³ç›®</div>
    <div class="input-grid">
        <div><span class="label">ğŸ“… æ—¥æœŸ</span><input type="date" id="entry-date"></div>
        <div><span class="label">ğŸ’µ é‡‘é¡</span><input type="number" id="amount" placeholder="é‡‘é¡" inputmode="decimal"></div>
    </div>
    <div class="input-grid">
        <div><span class="label">ğŸ“ é …ç›®</span><input type="text" id="desc" placeholder="åç¨±"></div>
        <div><span class="label">ğŸ·ï¸ åˆ†é¡</span>
            <select id="type">
                <optgroup label="æ”¯å‡º">
                    <option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option><option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option><option value="é†«ç™‚">ğŸ¥ é†«ç™‚</option>
                </optgroup>
                <optgroup label="æ”¶å…¥">
                    <option value="æœ¬è–ª">ğŸ’° æœ¬è–ª</option><option value="å‡ºå·®è²»">âœˆï¸ å‡ºå·®è²»</option><option value="çé‡‘">ğŸ§§ çé‡‘</option><option value="è‚¡ç¥¨æ”¶ç›Š">ğŸ“ˆ è‚¡ç¥¨æ”¶ç›Š</option><option value="è‚¡æ¯">ğŸ’¹ è‚¡æ¯</option><option value="å…¶ä»–">ğŸŒ å…¶ä»–</option>
                </optgroup>
            </select>
        </div>
    </div>
    <div class="input-grid">
        <div><span class="label">ğŸ‘¤ å°è±¡</span>
            <select id="member">
                <option value="æˆ‘">ğŸ§‘ æˆ‘</option><option value="è€å©†">ğŸ‘© è€å©†</option><option value="å†°æ£’">ğŸ• å†°æ£’</option><option value="é›ªç³•">ğŸˆ é›ªç³•</option><option value="å®¶åº­">ğŸ  å®¶åº­</option><option value="å®¶æ—">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—</option>
            </select>
        </div>
        <div style="display:flex; align-items:flex-end;"><button onclick="saveData()" id="saveBtn" class="save-btn">ç¢ºèªåŒæ­¥</button></div>
    </div>

    <div class="section-title">ğŸ” æˆå“¡èŠ±è²»æŸ¥è©¢</div>
    <div class="input-grid">
        <div><span class="label">ğŸ‘¤ é¸æ“‡æˆå“¡</span>
            <select id="q-mem">
                <option value="æˆ‘">ğŸ§‘ æˆ‘</option><option value="è€å©†">ğŸ‘© è€å©†</option><option value="å†°æ£’">ğŸ• å†°æ£’</option><option value="é›ªç³•">ğŸˆ é›ªç³•</option><option value="å®¶åº­">ğŸ  å®¶åº­</option><option value="å®¶æ—">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—</option>
            </select>
        </div>
        <div><span class="label">ğŸ“… é–‹å§‹</span><input type="date" id="q-start"></div>
    </div>
    <div class="input-grid">
        <div><span class="label">ğŸ“… çµæŸ</span><input type="date" id="q-end"></div>
        <div style="display:flex; align-items:flex-end;"><button onclick="queryMem()" class="query-btn">è¨ˆç®—é‡‘é¡</button></div>
    </div>
    <div id="search-res">
        <div id="res-t" style="font-size: 11px; color: #94a3b8;"></div>
        <div id="res-v" style="font-size: 20px; font-weight: 900; color: var(--neon-blue);"></div>
    </div>
</div>

<input type="hidden" id="h-start"><input type="hidden" id="h-end">

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwPu2wDdL1oX-izhvJSNjxEpFbskKunk8eCalpjlSl4V_obFjDxBqLH1HzWGUof__hd/exec"; 
    let rawRows = [];
    const colors = {
        exp: ['#FF3131', '#FF9F43', '#FECA57', '#54A0FF', '#5F27CD'],
        inc: ['#39FF14', '#00D2FF', '#BC13FE', '#FF00FF', '#FFFF00'],
        net: ['#1E293B', '#00D2FF']
    };

    google.charts.load('current', {'packages':['corechart']});

    window.onload = () => {
        const t = new Date().toISOString().split('T')[0];
        document.getElementById('entry-date').value = t;
        document.getElementById('q-start').value = t.substring(0,8) + "01";
        document.getElementById('q-end').value = t;
        setQuickDate('month', document.querySelector('.quick-btns button.active'));
        fetchData();
    };

    async function fetchData() {
        try { const r = await fetch(GAS_URL); rawRows = await r.json(); filterData(); } catch(e){ console.error(e); }
    }

    function setQuickDate(mode, btn) {
        document.querySelectorAll('.quick-btns button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const now = new Date();
        let s = new Date(now.getFullYear(), now.getMonth(), 1);
        let e = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        if(mode==='today'){ s=now; e=now; }
        else if(mode==='year'){ s=new Date(now.getFullYear(), 0, 1); e=new Date(now.getFullYear(), 11, 31); }
        document.getElementById('h-start').value = s.toISOString().split('T')[0];
        document.getElementById('h-end').value = e.toISOString().split('T')[0];
        if(rawRows.length > 0) filterData();
    }

    function filterData() {
        const s = new Date(document.getElementById('h-start').value);
        const e = new Date(document.getElementById('h-end').value).setHours(23,59,59);
        let i_t=0, e_t=0, eM={}, iM={};
        const incTs = ["æœ¬è–ª", "å‡ºå·®è²»", "çé‡‘", "è‚¡ç¥¨æ”¶ç›Š", "è‚¡æ¯", "å…¶ä»–"];

        for (let i = 1; i < rawRows.length; i++) {
            const d = new Date(rawRows[i][0]), a = Number(rawRows[i][2]), c = rawRows[i][3];
            if (d >= s && d <= e) {
                if (incTs.includes(c)) { i_t+=a; iM[c] = (iM[c]||0)+a; }
                else { e_t+=a; eM[c] = (eM[c]||0)+a; }
            }
        }
        document.getElementById('disp-income').innerText = `$${i_t.toLocaleString()}`;
        document.getElementById('disp-expense').innerText = `$${e_t.toLocaleString()}`;
        document.getElementById('disp-net').innerText = `$${(i_t-e_t).toLocaleString()}`;

        google.charts.setOnLoadCallback(() => {
            draw('exp-chart', Object.entries(eM), colors.exp, 'exp-legend');
            draw('inc-chart', Object.entries(iM), colors.inc, 'inc-legend');
            draw('net-chart', [['æ”¯å‡º', e_t], ['çµé¤˜', (i_t-e_t)>0?(i_t-e_t):0]], colors.net, 'net-legend');
        });
    }

    function draw(id, dataArr, clrs, legId) {
        const con = document.getElementById(id);
        const leg = document.getElementById(legId);
        leg.innerHTML = '';
        if (dataArr.length === 0) { con.innerHTML = "<div style='margin-top:30px;font-size:9px;'>ç„¡è³‡æ–™</div>"; return; }
        const data = google.visualization.arrayToDataTable([['L','V'], ...dataArr]);
        new google.visualization.PieChart(con).draw(data, {
            backgroundColor: 'transparent', pieHole: 0.6, colors: clrs,
            legend: 'none', chartArea: {width:'100%', height:'100%'}, pieSliceBorderColor: "none", pieSliceText: 'none'
        });
        dataArr.forEach((item, idx) => {
            leg.innerHTML += `<div class="legend-item"><span class="dot" style="background:${clrs[idx%clrs.length]}"></span>${item[0]}</div>`;
        });
    }

    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('entry-date').value,
            desc: document.getElementById('desc').value || "æœªå‘½å",
            amount: document.getElementById('amount').value,
            type: document.getElementById('type').value,
            member: document.getElementById('member').value,
            method: "æ‰‹å‹•è¼¸å…¥"
        };
        
        if (!data.amount) {
            alert("âš ï¸ è«‹è¼¸å…¥é‡‘é¡å†é€²è¡ŒåŒæ­¥");
            return;
        }

        // è¦–è¦ºé–å®šæŒ‰éˆ•
        btn.disabled = true;
        btn.innerText = "â³ åŒæ­¥ä¸­...";
        btn.style.opacity = "0.6";

        try {
            // ç™¼é€è‡³ GAS
            await fetch(GAS_URL, { 
                method: "POST", 
                mode: 'no-cors', 
                body: JSON.stringify(data) 
            });

            // âœ… é—œéµæé†’ï¼šåŒæ­¥å®Œæˆ
            alert("âœ… åŒæ­¥å®Œæˆï¼è³‡æ–™å·²å¯«å…¥è©¦ç®—è¡¨ã€‚");
            
            // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°åœ–è¡¨
            location.reload();
        } catch (e) {
            alert("âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– GAS ç¶²å€ã€‚");
            btn.disabled = false;
            btn.innerText = "ç¢ºèªåŒæ­¥";
            btn.style.opacity = "1";
        }
    }

    function queryMem() {
        const target = document.getElementById('q-mem').value;
        const s = new Date(document.getElementById('q-start').value);
        const e = new Date(document.getElementById('q-end').value).setHours(23,59,59);
        const incTs = ["æœ¬è–ª", "å‡ºå·®è²»", "çé‡‘", "è‚¡ç¥¨æ”¶ç›Š", "è‚¡æ¯", "å…¶ä»–"];
        let total = 0;
        for (let i = 1; i < rawRows.length; i++) {
            const d = new Date(rawRows[i][0]), a = Number(rawRows[i][2]), c = rawRows[i][3], m = rawRows[i][4];
            if (d >= s && d <= e && m === target && !incTs.includes(c)) { total += a; }
        }
        document.getElementById('search-res').style.display = 'block';
        document.getElementById('res-t').innerText = `${target} çš„å€é–“èŠ±è²»ï¼š`;
        document.getElementById('res-v').innerText = `$${total.toLocaleString()}`;
    }
</script>
</body>
</html>