<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joe's Finance Pro V12.0</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --neon-blue: #00d2ff; --neon-green: #39ff14; --neon-red: #ff3131;
            --bg-dark: #0f172a; --glass: rgba(30, 41, 59, 0.9);
        }
        body {
            font-family: 'Segoe UI', sans-serif; background: var(--bg-dark);
            background-image: radial-gradient(circle at top right, rgba(0,210,255,0.1), transparent);
            color: white; margin: 0; padding: 15px; display: flex; justify-content: center;
        }
        .card { background: var(--glass); backdrop-filter: blur(15px); width: 100%; max-width: 450px; padding: 20px; border-radius: 24px; border: 1px solid rgba(0, 210, 255, 0.3); }
        
        /* ç¯©é¸å€ */
        .filter-zone { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 18px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .filter-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .filter-row input { flex: 1; padding: 8px; font-size: 12px; background: #000; border: 1px solid var(--neon-blue); color: white; border-radius: 8px; }
        .quick-btns { display: flex; gap: 5px; }
        .quick-btns button { flex: 1; padding: 6px; font-size: 11px; background: rgba(255,255,255,0.1); border: none; color: #ccc; border-radius: 6px; cursor: pointer; }
        .quick-btns button.active { background: var(--neon-blue); color: #000; font-weight: bold; }

        /* çœ‹æ¿ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 15px; }
        .stat-box { text-align: center; }
        .stat-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: bold; font-family: monospace; }
        .income-text { color: var(--neon-green); } .expense-text { color: var(--neon-red); } .net-text { color: var(--neon-blue); }

        #piechart { width: 100%; height: 180px; margin-bottom: 15px; }

        /* è¼¸å…¥å€ */
        .input-group { margin-bottom: 10px; }
        .label { font-size: 11px; color: var(--neon-blue); margin-bottom: 3px; display: block; }
        input, select { width: 100%; padding: 10px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; box-sizing: border-box; }
        #amount { font-size: 20px; color: var(--neon-green); text-align: center; font-weight: bold; }
        .save-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, var(--neon-blue), #0081ff); border: none; border-radius: 12px; color: #000; font-size: 16px; font-weight: 900; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="text-align: center; color: var(--neon-blue); margin-top: 0; letter-spacing: 2px;">FINANCE PRO V12</h3>

    <div class="filter-zone">
        <div class="filter-row">
            <input type="date" id="start-date" onchange="filterData()">
            <span style="font-size: 12px; color: #666;">è‡³</span>
            <input type="date" id="end-date" onchange="filterData()">
        </div>
        <div class="quick-btns">
            <button onclick="setQuickDate('today', this)">ä»Šæ—¥</button>
            <button onclick="setQuickDate('month', this)" class="active">æœ¬æœˆ</button>
            <button onclick="setQuickDate('year', this)">æœ¬å¹´</button>
            <button onclick="setQuickDate('all', this)">å…¨éƒ¨</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="stat-box"><div class="stat-label">æ”¶å…¥</div><div id="disp-income" class="stat-value income-text">$ 0</div></div>
        <div class="stat-box"><div class="stat-label">æ”¯å‡º</div><div id="disp-expense" class="stat-value expense-text">$ 0</div></div>
        <div class="stat-box" style="grid-column: span 2; margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 5px;">
            <div class="stat-label">æ·¨çµé¤˜</div><div id="disp-net" class="stat-value net-text">$ 0</div>
        </div>
    </div>

    <div id="piechart"></div>

    <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.05); margin: 15px 0;">

    <div class="input-group">
        <span class="label">æ—¥æœŸ</span>
        <input type="date" id="entry-date">
    </div>
    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px;">
        <div class="input-group"><span class="label">é …ç›®</span><input type="text" id="desc" placeholder="åç¨±"></div>
        <div class="input-group"><span class="label">å°è±¡</span>
            <select id="member"><option value="æˆ‘">æˆ‘</option><option value="è€å©†">è€å©†</option><option value="å†°æ£’">å†°æ£’</option><option value="é›ªç³•">é›ªç³•</option><option value="å®¶åº­">å®¶åº­</option></select>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div class="input-group"><span class="label">é‡‘é¡</span><input type="number" id="amount" placeholder="0" inputmode="decimal"></div>
        <div class="input-group"><span class="label">é¡åˆ¥</span>
            <select id="type"><option value="é£²é£Ÿ">ğŸ” é£²é£Ÿ</option><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="ç”Ÿæ´»">ğŸ  ç”Ÿæ´»</option><option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option><option value="é†«ç™‚">ğŸ¥ é†«ç™‚</option><option value="æœ¬è–ª">ğŸ’° æœ¬è–ª</option><option value="å…¶ä»–æ”¶å…¥">ğŸ§§ å…¶ä»–æ”¶å…¥</option></select>
        </div>
    </div>
    <button onclick="saveData()" id="saveBtn" class="save-btn">ç¢ºèªåŒæ­¥</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwPu2wDdL1oX-izhvJSNjxEpFbskKunk8eCalpjlSl4V_obFjDxBqLH1HzWGUof__hd/exec"; 
    let rawRows = []; // å„²å­˜å¾ GAS æŠ“å›ä¾†çš„åŸå§‹è³‡æ–™

    google.charts.load('current', {'packages':['corechart']});

    window.onload = function() {
        document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
        setQuickDate('month', document.querySelector('.quick-btns button.active'));
        fetchFullData();
    };

    // æŠ“å–å…¨é‡è³‡æ–™
    async function fetchFullData() {
        try {
            const response = await fetch(GAS_URL);
            rawRows = await response.json();
            filterData();
        } catch (e) { document.getElementById('piechart').innerHTML = "é€£ç·šå¤±æ•—"; }
    }

    // å¿«æ·æ—¥æœŸè¨­å®š
    function setQuickDate(mode, btn) {
        document.querySelectorAll('.quick-btns button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const now = new Date();
        let start = new Date();
        let end = new Date();

        if (mode === 'today') {
            start = now; end = now;
        } else if (mode === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        } else if (mode === 'year') {
            start = new Date(now.getFullYear(), 0, 1);
            end = new Date(now.getFullYear(), 11, 31);
        } else {
            start = new Date(2000, 0, 1);
            end = new Date(2100, 11, 31);
        }

        document.getElementById('start-date').value = start.toISOString().split('T')[0];
        document.getElementById('end-date').value = end.toISOString().split('T')[0];
        if (rawRows.length > 0) filterData();
    }

    // æ ¸å¿ƒéæ¿¾èˆ‡è¨ˆç®—é‚è¼¯
    function filterData() {
        const start = new Date(document.getElementById('start-date').value);
        const end = new Date(document.getElementById('end-date').value);
        end.setHours(23, 59, 59);

        let income = 0, expense = 0, categoryMap = {};
        const incomeTypes = ["æœ¬è–ª", "å‡ºå·®è£œåŠ©", "è‚¡ç¥¨åƒ¹å·®", "è‚¡åˆ©æ”¶ç›Š", "å…¶ä»–æ”¶å…¥"];

        for (let i = 1; i < rawRows.length; i++) {
            const rowDate = new Date(rawRows[i][0]);
            const amt = Number(rawRows[i][2]);
            const cat = rawRows[i][3];

            if (rowDate >= start && rowDate <= end) {
                if (incomeTypes.includes(cat)) {
                    income += amt;
                } else {
                    expense += amt;
                    categoryMap[cat] = (categoryMap[cat] || 0) + amt;
                }
            }
        }

        document.getElementById('disp-income').innerText = `$ ${income.toLocaleString()}`;
        document.getElementById('disp-expense').innerText = `$ ${expense.toLocaleString()}`;
        document.getElementById('disp-net').innerText = `$ ${(income - expense).toLocaleString()}`;

        const chartData = Object.entries(categoryMap);
        google.charts.setOnLoadCallback(() => drawChart(chartData));
    }

    function drawChart(chartData) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Category');
        data.addColumn('number', 'Amount');
        data.addRows(chartData);
        const options = {
            backgroundColor: 'transparent', pieHole: 0.4,
            legend: { textStyle: { color: '#94a3b8', fontSize: 10 }, position: 'right' },
            colors: ['#00d2ff', '#39ff14', '#ff3131', '#facc15', '#a855f7'],
            chartArea: { width: '100%', height: '85%' }, pieSliceBorderColor: "none"
        };
        new google.visualization.PieChart(document.getElementById('piechart')).draw(data, options);
    }

    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const data = {
            date: document.getElementById('entry-date').value,
            desc: document.getElementById('desc').value,
            amount: document.getElementById('amount').value,
            type: document.getElementById('type').value,
            member: document.getElementById('member').value,
            method: "æ‰‹å‹•è¼¸å…¥"
        };
        if (!data.desc || !data.amount) return alert("è«‹å¡«å¯«å®Œæ•´");
        btn.disabled = true;
        try {
            await fetch(GAS_URL, { method: "POST", mode: 'no-cors', body: JSON.stringify(data) });
            alert("âœ… åŒæ­¥æˆåŠŸ");
            location.reload(); 
        } catch (e) { alert("å¤±æ•—"); btn.disabled = false; }
    }
</script>
</body>
</html>
